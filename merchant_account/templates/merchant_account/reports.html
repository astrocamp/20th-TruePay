{% extends 'merchant_layout/dashboard_base.html' %}
{% load static %}

{% block title %}å ±è¡¨åˆ†æ - {{ merchant.ShopName }} - TruePay{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
{% endblock %}

{% block content %}
<!-- é é¢æ¨™é¡Œ -->
<div class="mb-6">
    <h1 class="text-3xl font-bold text-gray-900">å ±è¡¨åˆ†æ</h1>
    <p class="text-gray-600">æŸ¥çœ‹å•†åº—ç‡Ÿé‹æ•¸æ“šèˆ‡è¶¨å‹¢åˆ†æ</p>
</div>

<!-- æ™‚é–“ç¯„åœé¸æ“‡å™¨ -->
<div class="mb-6 bg-white rounded-lg shadow-md p-4">
    <div class="flex items-center justify-between">
        <h2 class="text-lg font-medium text-gray-900">çµ±è¨ˆæœŸé–“</h2>
        <div class="flex space-x-2">
            <a href="?days=7"
               class="px-4 py-2 text-sm rounded-md transition-colors duration-200 {% if days == 7 %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                æœ€è¿‘ 7 å¤©
            </a>
            <a href="?days=30"
               class="px-4 py-2 text-sm rounded-md transition-colors duration-200 {% if days == 30 %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                æœ€è¿‘ 30 å¤©
            </a>
            <a href="?days=90"
               class="px-4 py-2 text-sm rounded-md transition-colors duration-200 {% if days == 90 %}bg-blue-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
                æœ€è¿‘ 90 å¤©
            </a>
        </div>
    </div>
</div>

<!-- çµ±è¨ˆå¡ç‰‡ -->
<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <!-- ç¸½ç‡Ÿæ”¶ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-sm font-medium">ç¸½ç‡Ÿæ”¶</p>
                <p class="text-3xl font-bold text-green-600 mt-2">NT$ {{ total_revenue|floatformat:0 }}</p>
                <p class="text-gray-500 text-sm mt-1">ç´¯è¨ˆé‡‘é¡</p>
            </div>
            <div class="p-3 bg-green-50 rounded-full">
                <span class="text-2xl">ğŸ’°</span>
            </div>
        </div>
    </div>

    <!-- ç¸½è¨‚å–®æ•¸ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-sm font-medium">ç¸½è¨‚å–®æ•¸</p>
                <p class="text-3xl font-bold text-[#0056B3] mt-2">{{ total_orders }}</p>
                <p class="text-gray-500 text-sm mt-1">äº¤æ˜“è¨‚å–®</p>
            </div>
            <div class="p-3 bg-blue-50 rounded-full">
                <span class="text-2xl">ğŸ“‹</span>
            </div>
        </div>
    </div>

    <!-- ç¥¨åˆ¸æ•¸é‡ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-sm font-medium">ç™¼è¡Œç¥¨åˆ¸</p>
                <p class="text-3xl font-bold text-yellow-600 mt-2">{{ total_tickets }}</p>
                <p class="text-gray-500 text-sm mt-1">ä½¿ç”¨ç‡ {{ ticket_usage_rate }}%</p>
            </div>
            <div class="p-3 bg-yellow-50 rounded-full">
                <span class="text-2xl">ğŸ«</span>
            </div>
        </div>
    </div>

    <!-- å•†å“æ•¸é‡ -->
    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 p-6 hover:shadow-md transition-shadow">
        <div class="flex items-center justify-between">
            <div>
                <p class="text-gray-600 text-sm font-medium">å•†å“ç¸½æ•¸</p>
                <p class="text-3xl font-bold text-purple-600 mt-2">{{ total_products }}</p>
                <p class="text-gray-500 text-sm mt-1">æ´»èºå•†å“</p>
            </div>
            <div class="p-3 bg-purple-50 rounded-full">
                <span class="text-2xl">ğŸ“¦</span>
            </div>
        </div>
    </div>
</div>

<!-- å ±è¡¨ä¸‹è¼‰å€åŸŸ -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
    <!-- éŠ·å”®åˆ†æå ±è¡¨ -->
    <div class="bg-white rounded-lg shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-200">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">éŠ·å”®åˆ†æå ±è¡¨</h3>
                    <p class="text-sm text-gray-600">ç‡Ÿæ”¶è¶¨å‹¢ã€è¨‚å–®ç‹€æ…‹ã€é‡‘æµåˆ†æ</p>
                </div>
            </div>
        </div>
        <div class="p-6">
            <ul class="text-sm text-gray-600 space-y-2 mb-4">
                <li>â€¢ ç‡Ÿæ”¶ç¸½è¦½èˆ‡è¶¨å‹¢åˆ†æ</li>
                <li>â€¢ è¨‚å–®æˆåŠŸç‡çµ±è¨ˆ</li>
                <li>â€¢ é‡‘æµæ–¹å¼ä½¿ç”¨æ¯”ä¾‹</li>
                <li>â€¢ å¹³å‡è¨‚å–®é‡‘é¡åˆ†æ</li>
            </ul>
            <div class="flex space-x-2">
                <button onclick="openChartModal('sales')"
                        class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-200 text-center">
                    <i class="fas fa-chart-pie mr-2"></i> é è¦½
                </button>
                <a href="{% url 'merchant_account:export_sales' subdomain=merchant.subdomain %}?days={{ days }}"
                   class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-200 inline-block text-center">
                    <i class="fas fa-download mr-2"></i>ä¸‹è¼‰ Excel
                </a>
            </div>
        </div>
    </div>

    <!-- ç¥¨åˆ¸ç‡Ÿé‹å ±è¡¨ -->
    <div class="bg-white rounded-lg shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-200">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">ç¥¨åˆ¸ç‡Ÿé‹å ±è¡¨</h3>
                    <p class="text-sm text-gray-600">ä½¿ç”¨ç‡ã€é©—è­‰è¨˜éŒ„ã€éæœŸåˆ†æ</p>
                </div>
            </div>
        </div>
        <div class="p-6">
            <ul class="text-sm text-gray-600 space-y-2 mb-4">
                <li>â€¢ ç¥¨åˆ¸ä½¿ç”¨ç‡çµ±è¨ˆ</li>
                <li>â€¢ é©—è­‰æˆåŠŸç‡åˆ†æ</li>
                <li>â€¢ éæœŸç¥¨åˆ¸æå¤±çµ±è¨ˆ</li>
                <li>â€¢ ä½¿ç”¨æ™‚é–“åˆ†ä½ˆåˆ†æ</li>
            </ul>
            <div class="flex space-x-2">
                <button onclick="openChartModal('tickets')"
                        class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-200 text-center">
                    <i class="fas fa-chart-pie mr-2"></i> é è¦½
                </button>
                <a href="{% url 'merchant_account:export_tickets' subdomain=merchant.subdomain %}?days={{ days }}"
                   class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-200 inline-block text-center">
                    <i class="fas fa-download mr-2"></i>ä¸‹è¼‰ Excel
                </a>
            </div>
        </div>
    </div>

    <!-- å•†å“è¡¨ç¾å ±è¡¨ -->
    <div class="bg-white rounded-lg shadow-md hover:shadow-lg hover:-translate-y-1 transition-all duration-200">
        <div class="p-6 border-b border-gray-200">
            <div class="flex items-center">
                <div>
                    <h3 class="text-lg font-medium text-gray-900">å•†å“è¡¨ç¾å ±è¡¨</h3>
                    <p class="text-sm text-gray-600">éŠ·é‡æ’è¡Œã€æ”¶å…¥è²¢ç»ã€åº«å­˜åˆ†æ</p>
                </div>
            </div>
        </div>
        <div class="p-6">
            <ul class="text-sm text-gray-600 space-y-2 mb-4">
                <li>â€¢ å•†å“éŠ·å”®æ’è¡Œæ¦œ</li>
                <li>â€¢ ç‡Ÿæ”¶è²¢ç»åº¦åˆ†æ</li>
                <li>â€¢ åº«å­˜ç‹€æ³çµ±è¨ˆ</li>
                <li>â€¢ å•†å“å®šåƒ¹æ•ˆç‡åˆ†æ</li>
            </ul>
            <div class="flex space-x-2">
                <button onclick="openChartModal('products')"
                        class="flex-1 bg-green-500 text-white px-4 py-2 rounded-md hover:bg-green-600 transition duration-200 text-center">
                    <i class="fas fa-chart-pie mr-2"></i> é è¦½
                </button>
                <a href="{% url 'merchant_account:export_products' subdomain=merchant.subdomain %}?days={{ days }}"
                   class="flex-1 bg-blue-500 text-white px-4 py-2 rounded-md hover:bg-blue-600 transition duration-200 inline-block text-center">
                    <i class="fas fa-download mr-2"></i>ä¸‹è¼‰ Excel
                </a>
            </div>
        </div>
    </div>
</div>

<!-- ä½¿ç”¨èªªæ˜ -->
<div class="mt-8 bg-blue-50 rounded-lg p-6">
    <h3 class="text-lg font-medium text-blue-900 mb-3">ğŸ“‹ å ±è¡¨ä½¿ç”¨èªªæ˜</h3>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm text-blue-800">
        <div>
            <h4 class="font-medium mb-2">å ±è¡¨åŠŸèƒ½</h4>
            <ul class="space-y-1">
                <li>â€¢ æ”¯æ´å¤šç¨®æ™‚é–“ç¯„åœé¸æ“‡</li>
                <li>â€¢ è‡ªå‹•ç”Ÿæˆè©³ç´°çµ±è¨ˆåœ–è¡¨</li>
                <li>â€¢ Excel æ ¼å¼æ–¹ä¾¿å¾ŒçºŒåˆ†æ</li>
            </ul>
        </div>
        <div>
            <h4 class="font-medium mb-2">æ›´æ–°é »ç‡</h4>
            <ul class="space-y-1">
                <li>â€¢ æ•¸æ“šå³æ™‚æ›´æ–°</li>
                <li>â€¢ å»ºè­°æ¯é€±ä¸‹è¼‰åˆ†æ</li>
                <li>â€¢ å¯ç”¨æ–¼ç‡Ÿé‹æ±ºç­–åƒè€ƒ</li>
            </ul>
        </div>
    </div>
</div>

<!-- åœ–è¡¨é è¦½æ¨¡æ…‹è¦–çª— -->
<div id="chartModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50" onclick="closeChartModal()">
    <div class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-lg shadow-xl max-w-4xl w-full max-h-[90vh] overflow-y-auto" onclick="event.stopPropagation()">
            <div class="p-6">
                <!-- æ¨¡æ…‹è¦–çª—æ¨™é¡Œ -->
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modalTitle" class="text-xl font-bold text-gray-900"></h3>
                    <button onclick="closeChartModal()" class="text-gray-400 hover:text-gray-600">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <!-- è¼‰å…¥å‹•ç•« -->
                <div id="loadingSpinner" class="flex justify-center items-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-blue-500"></div>
                    <span class="ml-3 text-gray-600">è¼‰å…¥åœ–è¡¨ä¸­...</span>
                </div>

                <!-- åœ–è¡¨åˆ†é  -->
                <div id="chartTabs" class="hidden">
                    <div class="flex border-b border-gray-200 mb-6">
                        <button id="tab1" class="py-2 px-4 text-sm font-medium text-center text-blue-600 bg-gray-50 border-b-2 border-blue-600 rounded-t-lg active" onclick="switchTab(1)">
                            ä¸»è¦åˆ†æ
                        </button>
                        <button id="tab2" class="py-2 px-4 ml-1 text-sm font-medium text-center text-gray-500 rounded-t-lg hover:text-gray-600 hover:bg-gray-50" onclick="switchTab(2)">
                            è©³ç´°åˆ†ä½ˆ
                        </button>
                    </div>

                    <!-- ä¸»è¦åœ–è¡¨ -->
                    <div id="chartTab1" class="chart-tab">
                        <canvas id="mainChart" width="800" height="400"></canvas>
                    </div>

                    <!-- è¼”åŠ©åœ–è¡¨ -->
                    <div id="chartTab2" class="chart-tab hidden">
                        <canvas id="subChart" width="800" height="400"></canvas>
                    </div>
                </div>

                <!-- éŒ¯èª¤è¨Šæ¯ -->
                <div id="errorMessage" class="hidden text-center py-12">
                    <div class="text-red-500 text-lg mb-2">
                        <i class="fas fa-exclamation-triangle"></i> è¼‰å…¥å¤±æ•—
                    </div>
                    <p class="text-gray-600">ç„¡æ³•è¼‰å…¥åœ–è¡¨æ•¸æ“šï¼Œè«‹ç¨å¾Œå†è©¦</p>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentCharts = [];
const currentDays = {{ days }};

// æ‰“é–‹åœ–è¡¨æ¨¡æ…‹è¦–çª—
function openChartModal(reportType) {
    const modal = document.getElementById('chartModal');
    const modalTitle = document.getElementById('modalTitle');
    const loadingSpinner = document.getElementById('loadingSpinner');
    const chartTabs = document.getElementById('chartTabs');
    const errorMessage = document.getElementById('errorMessage');

    // æ¸…ç†ä¹‹å‰çš„åœ–è¡¨
    currentCharts.forEach(chart => chart.destroy());
    currentCharts = [];

    // è¨­å®šæ¨™é¡Œ
    const titles = {
        'sales': 'éŠ·å”®åˆ†æåœ–è¡¨é è¦½',
        'tickets': 'ç¥¨åˆ¸ç‡Ÿé‹åœ–è¡¨é è¦½',
        'products': 'å•†å“è¡¨ç¾åœ–è¡¨é è¦½'
    };
    modalTitle.textContent = titles[reportType];

    // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—å’Œè¼‰å…¥å‹•ç•«
    modal.classList.remove('hidden');
    loadingSpinner.classList.remove('hidden');
    chartTabs.classList.add('hidden');
    errorMessage.classList.add('hidden');

    // è¼‰å…¥åœ–è¡¨æ•¸æ“š
    loadChartData(reportType);
}

// é—œé–‰åœ–è¡¨æ¨¡æ…‹è¦–çª—
function closeChartModal() {
    document.getElementById('chartModal').classList.add('hidden');
    // æ¸…ç†åœ–è¡¨å¯¦ä¾‹
    currentCharts.forEach(chart => chart.destroy());
    currentCharts = [];
}

// åˆ‡æ›åˆ†é 
function switchTab(tabNumber) {
    // æ›´æ–°åˆ†é æŒ‰éˆ•æ¨£å¼
    document.getElementById('tab1').className = tabNumber === 1
        ? 'py-2 px-4 text-sm font-medium text-center text-blue-600 bg-gray-50 border-b-2 border-blue-600 rounded-t-lg active'
        : 'py-2 px-4 ml-1 text-sm font-medium text-center text-gray-500 rounded-t-lg hover:text-gray-600 hover:bg-gray-50';

    document.getElementById('tab2').className = tabNumber === 2
        ? 'py-2 px-4 ml-1 text-sm font-medium text-center text-blue-600 bg-gray-50 border-b-2 border-blue-600 rounded-t-lg active'
        : 'py-2 px-4 ml-1 text-sm font-medium text-center text-gray-500 rounded-t-lg hover:text-gray-600 hover:bg-gray-50';

    // åˆ‡æ›åœ–è¡¨é¡¯ç¤º
    document.getElementById('chartTab1').classList.toggle('hidden', tabNumber !== 1);
    document.getElementById('chartTab2').classList.toggle('hidden', tabNumber !== 2);
}

// è¼‰å…¥åœ–è¡¨æ•¸æ“š
function loadChartData(reportType) {
    const url = `/merchant/api/chart-data/${reportType}/{{ merchant.subdomain }}/?days=${currentDays}`;

    fetch(url)
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                renderCharts(reportType, data.data);
                document.getElementById('loadingSpinner').classList.add('hidden');
                document.getElementById('chartTabs').classList.remove('hidden');
            } else {
                showError();
            }
        })
        .catch(error => {
            console.error('è¼‰å…¥åœ–è¡¨æ•¸æ“šå¤±æ•—:', error);
            showError();
        });
}

// é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
function showError() {
    document.getElementById('loadingSpinner').classList.add('hidden');
    document.getElementById('errorMessage').classList.remove('hidden');
}

// æ¸²æŸ“åœ–è¡¨
function renderCharts(reportType, data) {
    const mainCtx = document.getElementById('mainChart').getContext('2d');
    const subCtx = document.getElementById('subChart').getContext('2d');

    if (reportType === 'sales') {
        // éŠ·å”®åˆ†æ - ä¸»åœ–ï¼šç‡Ÿæ”¶è¶¨å‹¢ç·šåœ–
        const mainChart = new Chart(mainCtx, {
            type: 'line',
            data: {
                labels: data.trend_labels,
                datasets: [{
                    label: 'æ¯æ—¥ç‡Ÿæ”¶ (NT$)',
                    data: data.trend_data,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    tension: 0.3
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'ç‡Ÿæ”¶è¶¨å‹¢åˆ†æ'
                    }
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        ticks: {
                            callback: function(value) {
                                return 'NT$ ' + value.toLocaleString();
                            }
                        }
                    }
                }
            }
        });

        // è¼”åŠ©åœ–ï¼šé‡‘æµæ–¹å¼åœ“é¤…åœ–
        const subChart = new Chart(subCtx, {
            type: 'pie',
            data: {
                labels: data.payment_labels,
                datasets: [{
                    data: data.payment_data,
                    backgroundColor: [
                        '#FF6384',
                        '#36A2EB',
                        '#FFCE56',
                        '#4BC0C0',
                        '#9966FF'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'é‡‘æµæ–¹å¼ä½¿ç”¨æ¯”ä¾‹'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        currentCharts = [mainChart, subChart];

    } else if (reportType === 'tickets') {
        // ç¥¨åˆ¸ç‡Ÿé‹ - ä¸»åœ–ï¼šä½¿ç”¨ç‡åœ“é¤…åœ–
        const mainChart = new Chart(mainCtx, {
            type: 'pie',
            data: {
                labels: data.usage_labels,
                datasets: [{
                    data: data.usage_data,
                    backgroundColor: ['#10B981', '#EF4444', '#F59E0B']
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'ç¥¨åˆ¸ä½¿ç”¨ç‡çµ±è¨ˆ'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        // è¼”åŠ©åœ–ï¼šæ™‚é–“åˆ†å¸ƒæ©«æ¢åœ–
        const subChart = new Chart(subCtx, {
            type: 'bar',
            data: {
                labels: data.time_labels,
                datasets: [{
                    label: 'ä½¿ç”¨æ¬¡æ•¸',
                    data: data.time_data,
                    backgroundColor: 'rgba(59, 130, 246, 0.8)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'é©—è­‰æ™‚é–“åˆ†å¸ƒ'
                    }
                },
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });

        currentCharts = [mainChart, subChart];

    } else if (reportType === 'products') {
        // å•†å“è¡¨ç¾ - ä¸»åœ–ï¼šéŠ·å”®æ’è¡Œæ©«æ¢åœ–
        const mainChart = new Chart(mainCtx, {
            type: 'bar',
            data: {
                labels: data.ranking_labels,
                datasets: [{
                    label: 'éŠ·å”®æ•¸é‡',
                    data: data.ranking_data,
                    backgroundColor: 'rgba(16, 185, 129, 0.8)'
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'TOP 10 ç†±éŠ·å•†å“'
                    }
                },
                indexAxis: 'y',
                scales: {
                    x: {
                        beginAtZero: true
                    }
                }
            }
        });

        // è¼”åŠ©åœ–ï¼šç‡Ÿæ”¶è²¢ç»åœ“é¤…åœ–
        const subChart = new Chart(subCtx, {
            type: 'pie',
            data: {
                labels: data.revenue_labels,
                datasets: [{
                    data: data.revenue_data,
                    backgroundColor: [
                        '#8B5CF6',
                        '#06B6D4',
                        '#F59E0B',
                        '#EF4444',
                        '#10B981',
                        '#6B7280'
                    ]
                }]
            },
            options: {
                responsive: true,
                plugins: {
                    title: {
                        display: true,
                        text: 'å•†å“é¡åˆ¥ç‡Ÿæ”¶è²¢ç»'
                    },
                    legend: {
                        position: 'bottom'
                    }
                }
            }
        });

        currentCharts = [mainChart, subChart];
    }
}
</script>

{% endblock %}