{% load static %}
<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TruePay 商品卡片</title>
    <link rel="stylesheet" href="{% static 'styles/app.css' %}">
    <script src="{% static 'scripts/app.js' %}" defer></script>
</head>
<body class="m-0 p-2 bg-transparent">
    {% if error %}
        <div class="bg-white rounded-lg shadow-lg overflow-hidden max-w-sm mx-auto">
            <div class="p-6 text-center">
                <div class="text-red-500 text-lg font-semibold">{{ error }}</div>
            </div>
        </div>
    {% else %}
        <div class="bg-white rounded-lg shadow-lg overflow-hidden max-w-sm mx-auto"
             x-data="{
                 productId: {{ product.id }},
                 canManage: {{ can_manage|yesno:'true,false' }},
                 manageToken: '{{ manage_token|default:'' }}',
                 editMode: false,
                 saving: false,
                 message: '',
                 messageType: 'success',
                 productData: {},
                 editData: {},

                 init() {
                     this.updateHeight();
                     this.resetEditData();
                 },

                 updateHeight() {
                     const height = document.body.scrollHeight;
                     if (window.parent) {
                         window.parent.postMessage({ type: 'truepay-resize', height }, '*');
                     }
                 },

                 resetEditData() {
                     this.editData = { ...this.productData };
                 },

                 toggleEditMode() {
                     this.editMode = !this.editMode;
                     this.message = '';
                     if (this.editMode) this.resetEditData();
                     this.$nextTick(() => this.updateHeight());
                 },

                 cancelEdit() {
                     this.editMode = false;
                     this.message = '';
                     this.resetEditData();
                     this.$nextTick(() => this.updateHeight());
                 },

                 async saveProduct() {
                     this.saving = true;
                     this.message = '';

                     try {
                         const response = await fetch(`/embed/api/products/${this.productId}/update/`, {
                             method: 'PATCH',
                             headers: {
                                 'Content-Type': 'application/json',
                                 'Authorization': `Bearer ${this.manageToken}`,
                                 'X-CSRFToken': this.getCsrfToken()
                             },
                             body: JSON.stringify(this.editData)
                         });

                         const data = await response.json();

                         if (response.ok) {
                             this.productData = { ...this.productData, ...data.product };
                             this.message = '商品資訊已成功更新！';
                             this.messageType = 'success';

                             setTimeout(() => {
                                 this.editMode = false;
                                 this.message = '';
                                 this.$nextTick(() => this.updateHeight());
                             }, 2000);
                         } else {
                             this.message = data.error || '更新失敗';
                             this.messageType = 'error';
                         }
                     } catch (error) {
                         this.message = '網路錯誤，請稍後再試';
                         this.messageType = 'error';
                     }

                     this.saving = false;
                     this.$nextTick(() => this.updateHeight());
                 },

                 getCsrfToken() {
                     const cookies = document.cookie.split(';');
                     for (let cookie of cookies) {
                         const [name, value] = cookie.trim().split('=');
                         if (name === 'csrftoken') return value;
                     }
                     return '';
                 }
             }"
             x-init="productData = {
                 name: '{{ product.name|escapejs }}',
                 description: '{{ product.description|escapejs }}',
                 price: {{ product.price }},
                 stock: {{ product.stock }},
                 is_active: {{ product.is_active|yesno:'true,false' }},
                 purchase_url: '/shop/{{ product.merchant.subdomain }}/pay/{{ product.id }}/'
             }; init()">

            <!-- 管理工具列 -->
            <div x-show="canManage && !editMode" class="bg-blue-500 text-white px-3 py-2 text-sm flex justify-between items-center">
                <span>管理模式</span>
                <button @click="toggleEditMode()" class="bg-gray-600 hover:bg-gray-700 px-3 py-1 rounded text-xs">
                    編輯商品
                </button>
            </div>

            <!-- 商品展示 -->
            <div x-show="!editMode">
                {% if product.image %}
                    <div class="aspect-video overflow-hidden">
                        <img src="{{ product.image.url }}" alt="{{ product.name }}" class="w-full h-full object-cover">
                    </div>
                {% endif %}

                <div class="p-4">
                    <h3 class="text-lg font-bold text-gray-900 mb-2" x-text="productData.name">{{ product.name }}</h3>
                    <p class="text-gray-600 mb-3 text-sm leading-relaxed" x-text="productData.description">{{ product.description }}</p>

                    <div class="flex items-center justify-between mb-4">
                        <div class="text-xl font-bold text-blue-600">
                            NT$ <span x-text="productData.price">{{ product.price }}</span>
                        </div>
                        <div class="text-xs text-gray-500">
                            庫存: <span x-text="productData.stock">{{ product.stock }}</span>
                        </div>
                    </div>

                    <a :href="productData.purchase_url" target="_parent"
                       class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded w-full block text-center text-sm font-medium">
                        立即購買
                    </a>

                    <div class="mt-2 text-center">
                        <div class="text-xs text-gray-400">by {{ product.merchant.ShopName }}</div>
                    </div>
                </div>
            </div>

            <!-- 編輯模式 -->
            <div x-show="editMode" class="p-4 bg-gray-50">
                <h4 class="text-lg font-semibold mb-4">編輯商品資訊</h4>

                <form @submit.prevent="saveProduct()" class="space-y-3">
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">商品名稱</label>
                        <input type="text" x-model="editData.name"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">商品描述</label>
                        <textarea x-model="editData.description" rows="3"
                                  class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"></textarea>
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">價格 (NT$)</label>
                        <input type="number" x-model="editData.price" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>

                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-1">庫存</label>
                        <input type="number" x-model="editData.stock" min="0"
                               class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm">
                    </div>

                    <div>
                        <label class="flex items-center">
                            <input type="checkbox" x-model="editData.is_active" class="mr-2">
                            <span class="text-sm text-gray-700">商品上架</span>
                        </label>
                    </div>

                    <div class="flex gap-2 pt-2">
                        <button type="submit" :disabled="saving"
                                class="bg-blue-500 hover:bg-blue-600 disabled:bg-blue-300 text-white px-4 py-2 rounded flex-1 text-sm">
                            <span x-show="!saving">儲存變更</span>
                            <span x-show="saving">儲存中...</span>
                        </button>
                        <button type="button" @click="cancelEdit()"
                                class="bg-gray-500 hover:bg-gray-600 text-white px-4 py-2 rounded text-sm">
                            取消
                        </button>
                    </div>
                </form>

                <div x-show="message" class="mt-3 p-3 rounded-md text-sm"
                     :class="messageType === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'">
                    <span x-text="message"></span>
                </div>
            </div>
        </div>
    {% endif %}
</body>
</html>