{% extends 'layouts/default.html' %}
{% block main_container_classes %}marketplace-bg{% endblock %}
{% load static %}
{% load i18n %}

{% block title %}{% trans "商品總覽" %} - TruePay{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <!-- 頁面標題 -->
    <div class="mb-8">
        <div class="flex justify-between items-center mb-2">
            <h1 class="text-4xl font-bold text-gray-900">{% trans "商品總覽" %}</h1>
            {% if user.is_authenticated and user.member_type == "merchant" %}
                <a href="{% url 'merchant_marketplace:new' user.merchant.subdomain %}"
                   class="bg-blue-600 text-white px-6 py-2 rounded-lg hover:bg-blue-700 transition-colors flex items-center gap-2 font-medium">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                    </svg>
                    {% trans "新增商品" %}
                </a>
            {% endif %}
        </div>
        <p class="text-lg text-gray-600">{% trans "探索各大商家的精選商品" %}</p>
    </div>

    <!-- 商品篩選 -->
    <div class="mb-8">
        <div class="flex items-center justify-between">
            <p class="text-sm text-gray-500">
                {% blocktrans with count=products.paginator.count %}共找到 {{ count }} 個商品{% endblocktrans %}
            </p>
            <p class="text-sm text-gray-500">
                {% blocktrans with current=products.number total=products.paginator.num_pages %}第 {{ current }} 頁，共 {{ total }} 頁{% endblocktrans %}
            </p>
        </div>
    </div>

    <!-- 商品列表 -->
    {% if products %}
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 xl:grid-cols-4 gap-6">
        {% for product in products %}
        <div class="marketplace-product-card group">
            <!-- 商品圖片 -->
            <div class="aspect-square overflow-hidden bg-gray-50">
                {% if product.image %}
                    <img src="{{ product.image.url }}" 
                         alt="{{ product.name }}" 
                         class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                {% else %}
                    <div class="w-full h-full flex items-center justify-center bg-gray-100">
                        {% include 'components/icons.html' with icon='image-placeholder' class='w-12 h-12 text-gray-400' %}
                    </div>
                {% endif %}
            </div>

            <!-- 商品資訊 -->
            <div class="p-4">
                <div class="mb-2">
                    <h3 class="product-title text-xl truncate mb-1">{{ product.name }}</h3>
                    <p class="product-merchant text-sm mb-2">{{ product.merchant.ShopName }}</p>
                </div>

                <div class="flex items-center justify-between">
                    <div class="product-price text-3xl">
                        NT$ {{ product.price|floatformat:0 }}
                    </div>
                    
                    <!-- 庫存狀態 -->
                    {% if product.stock > 0 %}
                        <span class="stock-badge-available text-xs px-2 py-1 rounded-full">
                            {% blocktrans with stock=product.stock %}庫存 {{ stock }}{% endblocktrans %}
                        </span>
                    {% else %}
                        <span class="stock-badge-soldout text-xs px-2 py-1 rounded-full">
                            {% trans "已售完" %}
                        </span>
                    {% endif %}
                </div>

                <!-- 商品描述 -->
                {% if product.description %}
                <p class="product-description text-sm mt-3 line-clamp-2">{{ product.description }}</p>
                {% endif %}

                <!-- 購買按鈕 -->
                <div class="mt-4">
                    {% if product.stock > 0 %}
                        <a href="{% url 'public_store:payment_page' product.merchant.subdomain product.id %}"
                           class="product-button block w-full text-center py-2 px-4 rounded-xl transition-all">
                            {% trans "前往商品" %}
                        </a>
                    {% else %}
                        <button class="product-button-disabled block w-full text-center py-2 px-4 rounded-xl cursor-not-allowed">
                            {% trans "已售完" %}
                        </button>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- 沒有商品時的顯示 -->
    <div class="text-center py-16">
        <div class="mb-4">
            {% include 'components/icons.html' with icon='warning' class='w-16 h-16 text-gray-300 mx-auto' %}
        </div>
        <h3 class="text-xl font-medium text-gray-900 mb-2">{% trans "目前沒有商品" %}</h3>
        <p class="text-gray-500">{% trans "請稍後再來查看，或許會有新商品上架！" %}</p>
    </div>
    {% endif %}

    <!-- 分頁導航 -->
    {% if products.has_other_pages %}
    <div class="flex justify-center mt-12">
        <nav class="flex space-x-2">
            {% if products.has_previous %}
                <a href="?page=1" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    {% trans "首頁" %}
                </a>
                <a href="?page={{ products.previous_page_number }}" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    {% trans "上一頁" %}
                </a>
            {% endif %}

            {% for num in products.paginator.page_range %}
                {% if products.number == num %}
                    <span class="px-3 py-2 text-sm font-medium text-white bg-cis-primary border border-cis-primary rounded-md">
                        {{ num }}
                    </span>
                {% elif num > products.number|add:'-3' and num < products.number|add:'3' %}
                    <a href="?page={{ num }}" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                        {{ num }}
                    </a>
                {% endif %}
            {% endfor %}

            {% if products.has_next %}
                <a href="?page={{ products.next_page_number }}" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    {% trans "下一頁" %}
                </a>
                <a href="?page={{ products.paginator.num_pages }}" class="px-3 py-2 text-sm font-medium text-gray-500 bg-white border border-gray-300 rounded-md hover:bg-gray-50">
                    {% trans "最後頁" %}
                </a>
            {% endif %}
        </nav>
    </div>
    {% endif %}
</div>
{% endblock %}